<view class="container">
  <view class="mesh-bg">
    <view class="mesh-blob mesh-blob-1"></view>
    <view class="mesh-blob mesh-blob-2"></view>
  </view>

  <nav-bar title="录入分散式房源" showBack="{{true}}" background="rgba(241, 245, 249, 0.9)"></nav-bar>

  <scroll-view scroll-y class="form-scroll" style="padding-top: {{navHeight}}px;">
    
    <!-- AI Smart Fill -->
    <view class="form-section glass-card ai-section">
      <view class="ai-header">
        <view class="ai-title-group">
          <text class="ai-icon">✨</text>
          <text class="ai-title">AI 智能填单助手</text>
        </view>
        <view class="ai-tag">粘贴文本自动识别</view>
      </view>
      <textarea class="ai-textarea" placeholder="粘贴房源描述文本（如：徐汇区两室一厅 89平米 7500元/月 精装修...）" bindinput="onAiInput" value="{{aiInputText}}" maxlength="500"></textarea>
      <button class="ai-btn" bindtap="onSmartFill" loading="{{isAiParsing}}">
        <text>⚡ 立即智能识别</text>
      </button>
    </view>

    <!-- 1. Basic Info -->
    <view class="form-section glass-card">
      <view class="section-title">1. 基础信息</view>
      
      <view class="form-item">
        <text class="label">房源标题 <text class="required">*</text></text>
        <input class="input" placeholder="如: 国贸CBD精装两居室" data-field="title" value="{{formData.title}}" bindinput="onInput" />
      </view>

      <view class="form-item">
        <text class="label">小区/公寓名称</text>
        <input class="input" placeholder="例: 幸福家园" data-field="community" value="{{formData.community}}" bindinput="onInput" />
      </view>
      
      <view class="form-item">
          <text class="label">物业分类</text>
          <picker bindchange="bindCategoryChange" range="{{categoryOptions}}">
            <view class="picker-display">{{formData.category || '请选择'}} <text class="arrow">></text></view>
          </picker>
      </view>

      <view class="form-item">
        <text class="label">详细地址</text>
        <input class="input" placeholder="街道/门牌号" data-field="address" value="{{formData.address}}" bindinput="onInput" />
      </view>

      <!-- Building/Unit/Floor Grid -->
      <view class="form-row three-col">
        <view class="form-item">
            <text class="label sm-label">楼号</text>
            <input class="input sm-input" placeholder="8号楼" data-field="buildingNum" value="{{formData.buildingNum}}" bindinput="onInput" />
        </view>
        <view class="form-item">
            <text class="label sm-label">单元</text>
            <input class="input sm-input" placeholder="2单元" data-field="unitNum" value="{{formData.unitNum}}" bindinput="onInput" />
        </view>
        <view class="form-item">
            <text class="label sm-label">楼层</text>
            <input class="input sm-input" placeholder="601" data-field="floorNum" value="{{formData.floorNum}}" bindinput="onInput" />
        </view>
      </view>

      <view class="form-row">
        <view class="form-item half">
          <text class="label">户型</text>
          <picker bindchange="bindLayoutChange" value="{{0}}" range="{{layoutOptions}}">
            <view class="picker-display">{{formData.layout}} <text class="arrow">></text></view>
          </picker>
        </view>
        <view class="form-item half">
          <text class="label">面积 (㎡)</text>
          <input class="input" type="digit" placeholder="85" data-field="area" value="{{formData.area}}" bindinput="onInput" />
        </view>
      </view>
    </view>

     <!-- 2. Rent & Config -->
     <view class="form-section glass-card">
        <view class="section-title">2. 收费配置</view>
        
        <!-- Lease Terms & Commissions (Complex UI) -->
        <view class="form-group-title">租赁方式与佣金 (可多选)</view>
        <view class="lease-terms-group">
            <block wx:for="{{leaseTermOptions}}" wx:key="*this">
                <view class="lease-term-row {{utils.includes(formData.leaseTerms, item) ? 'active-row' : ''}}">
                    <view class="term-btn {{utils.includes(formData.leaseTerms, item) ? 'active-btn' : ''}}" bindtap="toggleLeaseTerm" data-term="{{item}}">
                        {{item}}
                    </view>
                    <view class="commission-input-wrapper" wx:if="{{utils.includes(formData.leaseTerms, item)}}">
                        <text class="comm-label">佣金:</text>
                        <input class="comm-input" placeholder="如: 50%月租" data-term="{{item}}" value="{{formData.commissions[item] || ''}}" bindinput="onCommissionInput" />
                    </view>
                </view>
            </block>
        </view>

        <view class="form-row" style="margin-top: 24rpx;">
            <view class="form-item half">
                <text class="label">月租金 (元) <text class="required">*</text></text>
                <input class="input price-input" type="digit" placeholder="0" data-field="rent" value="{{formData.rent}}" bindinput="onInput" />
            </view>
            <view class="form-item half">
                <text class="label">押金方式</text>
                <picker bindchange="bindDepositChange" range="{{depositOptions}}">
                    <view class="picker-display">{{formData.deposit}} <text class="arrow">></text></view>
                </picker>
            </view>
        </view>

        <view class="form-row">
            <view class="form-item half">
                <text class="label">支付方式</text>
                <picker bindchange="bindPaymentChange" range="{{paymentMethodOptions}}">
                    <view class="picker-display">{{formData.paymentMethod || '请选择'}} <text class="arrow">></text></view>
                </picker>
            </view>
            <view class="form-item half">
                <text class="label">最早入住</text>
                <picker bindchange="bindMoveInChange" range="{{moveInDateOptions}}">
                    <view class="picker-display">{{formData.moveInDate || '请选择'}} <text class="arrow">></text></view>
                </picker>
            </view>
        </view>

        <!-- Detailed Fees Grid -->
        <view class="form-group-title">杂费明细</view>
        <view class="fees-grid">
            <view class="fee-item"><text class="fee-label">💧 水费</text><input class="fee-input" placeholder="如 5元/吨" data-field="fees.water" value="{{formData.fees.water}}" bindinput="onInput"/></view>
            <view class="fee-item"><text class="fee-label">⚡ 电费</text><input class="fee-input" placeholder="如 1元/度" data-field="fees.electricity" value="{{formData.fees.electricity}}" bindinput="onInput"/></view>
            <view class="fee-item"><text class="fee-label">🔥 燃气</text><input class="fee-input" placeholder="如 3元/方" data-field="fees.gas" value="{{formData.fees.gas}}" bindinput="onInput"/></view>
            <view class="fee-item"><text class="fee-label">🏢 物业</text><input class="fee-input" placeholder="包含/自理" data-field="fees.propertyMgmt" value="{{formData.fees.propertyMgmt}}" bindinput="onInput"/></view>
            <view class="fee-item"><text class="fee-label">🌐 网费</text><input class="fee-input" placeholder="包含/自理" data-field="fees.internet" value="{{formData.fees.internet}}" bindinput="onInput"/></view>
            <view class="fee-item"><text class="fee-label">🚗 停车</text><input class="fee-input" placeholder="包含/自理" data-field="fees.parking" value="{{formData.fees.parking}}" bindinput="onInput"/></view>
            <view class="fee-item"><text class="fee-label">🤵 服务</text><input class="fee-input" placeholder="包含/自理" data-field="fees.serviceFee" value="{{formData.fees.serviceFee}}" bindinput="onInput"/></view>
        </view>
     </view>

    <!-- 3. Facilities & Description -->
    <view class="form-section glass-card">
        <view class="section-title">3. 详细配置</view>

        <view class="form-group-title">房源亮点 (标签)</view>
        <view class="tag-selector">
            <block wx:for="{{tagOptions}}" wx:key="*this">
                <view class="tag-option {{utils.includes(formData.tags, item) ? 'active' : ''}}" bindtap="toggleTag" data-tag="{{item}}">{{item}}</view>
            </block>
        </view>

        <view class="form-row" style="margin-top: 24rpx;">
             <view class="form-item half">
                <text class="label">水电燃气</text>
                <picker bindchange="bindUtilityChange" range="{{utilityOptions}}">
                    <view class="picker-display">{{formData.utilitiesStatus || '请选择'}} <text class="arrow">></text></view>
                </picker>
            </view>
            <view class="form-item half">
                <text class="label">墙面状况</text>
                <picker bindchange="bindWallChange" range="{{wallOptions}}">
                    <view class="picker-display">{{formData.wallCondition || '请选择'}} <text class="arrow">></text></view>
                </picker>
            </view>
        </view>

        <view class="form-group-title" style="margin-top: 24rpx;">周边配套</view>
        <view class="tag-selector">
            <block wx:for="{{nearbyOptions}}" wx:key="*this">
                <view class="tag-option {{utils.includes(formData.nearbyFacilities, item) ? 'active' : ''}}" bindtap="toggleNearby" data-item="{{item}}">{{item}}</view>
            </block>
        </view>

        <view class="form-group-title" style="margin-top: 24rpx;">房屋配置</view>
        <view class="tag-selector">
            <block wx:for="{{facilityOptions}}" wx:key="*this">
                <view class="tag-option {{utils.includes(formData.facilities, item) ? 'active' : ''}}" bindtap="toggleFacility" data-item="{{item}}">{{item}}</view>
            </block>
        </view>
        
        <view class="form-item" style="margin-top: 24rpx;">
            <text class="label">房源描述</text>
            <textarea class="desc-textarea" placeholder="详细介绍房屋状况、交通、周边设施..." data-field="desc" value="{{formData.desc}}" bindinput="onInput" maxlength="1000"></textarea>
         </view>
    </view>

    <!-- 4. Media -->
    <view class="form-section glass-card">
      <view class="section-title">4. 影像资料</view>
      
      <!-- Photos -->
      <view class="media-group">
        <text class="label">实拍照片 ({{formData.images.length}}/9)</text>
        <view class="image-grid">
            <block wx:for="{{formData.images}}" wx:key="*this">
                <view class="image-item">
                    <image src="{{item}}" mode="aspectFill" class="thumb"></image>
                    <view class="delete-btn" catchtap="removeImage" data-index="{{index}}">×</view>
                </view>
            </block>
            <view class="image-item add-btn" bindtap="chooseImage" wx:if="{{formData.images.length < 9}}">
                <text class="plus">+</text>
            </view>
        </view>
      </view>
      
      <!-- Videos -->
      <view class="media-group" style="margin-top: 32rpx;">
        <text class="label">视频资料 ({{formData.videos.length}})</text>
        <view class="video-list">
             <block wx:for="{{formData.videos}}" wx:key="*this">
                <view class="video-item">
                    <view class="video-icon">🎥</view>
                    <text class="video-name">视频_{{index+1}}</text>
                    <view class="delete-text" catchtap="removeVideo" data-index="{{index}}">删除</view>
                </view>
            </block>
            <view class="add-video-btn" bindtap="chooseVideo">
                <text>+ 添加视频</text>
            </view>
        </view>
      </view>

    </view>

    <!-- 5. Landlord Contacts -->
    <view class="form-section glass-card">
        <view class="section-title">5. 房东信息</view>
         <block wx:for="{{formData.landlordContacts}}" wx:key="index">
            <view class="contact-row">
                <input class="input contact-input" placeholder="姓名" data-index="{{index}}" data-field="name" value="{{item.name}}" bindinput="updateContact" />
                <input class="input contact-input" placeholder="电话" data-index="{{index}}" data-field="phone" value="{{item.phone}}" bindinput="updateContact" />
                 <view wx:if="{{index > 0}}" class="remove-contact" catchtap="removeContact" data-index="{{index}}">×</view>
            </view>
         </block>
         <view class="add-contact-link" bindtap="addContact">+ 添加联系人</view>
    </view>

    <view style="height: 180rpx;"></view>
  </scroll-view>

  <view class="bottom-bar glass-card">
    <button class="submit-btn" bindtap="onSubmit">确认录入</button>
  </view>
</view>

<wxs module="utils">
module.exports.includes = function(arr, item) {
  return arr && arr.indexOf(item) > -1
}
</wxs>
