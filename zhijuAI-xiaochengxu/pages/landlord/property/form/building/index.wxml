<view class="container">
  <view class="mesh-bg">
    <view class="mesh-blob mesh-blob-1"></view>
    <view class="mesh-blob mesh-blob-2"></view>
  </view>

  <nav-bar title="录入集中式公寓" showBack="{{true}}" background="rgba(241, 245, 249, 0.9)"></nav-bar>

  <scroll-view scroll-y class="form-scroll" style="padding-top: {{navHeight}}px;">
    
    <!-- AI Smart Fill (Kept for Description) -->
    <view class="form-section glass-card ai-section">
      <view class="ai-header">
        <view class="ai-title-group">
          <text class="ai-icon">✨</text>
          <text class="ai-title">AI 智能填单助手</text>
        </view>
        <view class="ai-tag">仅识别公寓描述与地址</view>
      </view>
      <textarea class="ai-textarea" placeholder="粘贴公寓整体描述文本..." bindinput="onAiInput" value="{{aiInputText}}" maxlength="500"></textarea>
      <!-- <button class="ai-btn" bindtap="onSmartFill" loading="{{isAiParsing}}">
        <text>⚡ 立即智能识别</text>
      </button> -->
    </view>

    <!-- 1. Building Info -->
    <view class="form-section glass-card">
      <view class="section-title">1. 公寓详情</view>
      
      <view class="form-item">
        <text class="label">公寓标题 <text class="required">*</text></text>
        <input class="input" placeholder="如: 泊寓(科技园店)" data-field="title" value="{{formData.title}}" bindinput="onInput" />
      </view>

      <view class="form-item">
        <text class="label">公寓/门店名称</text>
        <input class="input" placeholder="例: 泊寓(科技园店)" data-field="community" value="{{formData.community}}" bindinput="onInput" />
      </view>

      <!-- 省市区三级联动 -->
      <view class="form-item">
        <text class="label">地理位置</text>
        <view class="form-row three-col" style="margin-top: 12rpx;">
          <picker bindchange="bindProvinceChange" range="{{provinceOptions}}">
            <view class="picker-display sm-picker">{{formData.province}} <text class="arrow">></text></view>
          </picker>
          <picker bindchange="bindCityChange" range="{{cityOptions}}">
            <view class="picker-display sm-picker">{{formData.city}} <text class="arrow">></text></view>
          </picker>
          <picker bindchange="bindDistrictChange" range="{{districtOptions}}">
            <view class="picker-display sm-picker">{{formData.district || '区县'}} <text class="arrow">></text></view>
          </picker>
        </view>
      </view>

      <view class="form-item">
        <text class="label">详细地址</text>
        <input class="input" placeholder="街道/门牌号" data-field="address" value="{{formData.address}}" bindinput="onInput" />
      </view>
    </view>

     <!-- 2. Config & Fees -->
     <view class="form-section glass-card">
        <view class="section-title">2. 收费与相关配置</view>
        
        <view class="form-row">
            <view class="form-item half">
                <text class="label">支付方式</text>
                <picker bindchange="bindPaymentChange" range="{{paymentMethodOptions}}">
                    <view class="picker-display">{{formData.paymentMethod || '请选择'}} <text class="arrow">></text></view>
                </picker>
            </view>
            <view class="form-item half">
                <text class="label">押金方式</text>
                <picker bindchange="bindDepositChange" range="{{depositOptions}}">
                    <view class="picker-display">{{formData.deposit}} <text class="arrow">></text></view>
                </picker>
            </view>
        </view>

        <!-- Detailed Fees Grid -->
        <view class="form-group-title">杂费明细 (公寓统一标准)</view>
        <view class="fees-grid">
            <view class="fee-item"><text class="fee-label">💧 水费</text><input class="fee-input" placeholder="如 5元/吨" data-field="fees.water" value="{{formData.fees.water}}" bindinput="onInput"/></view>
            <view class="fee-item"><text class="fee-label">⚡ 电费</text><input class="fee-input" placeholder="如 1元/度" data-field="fees.electricity" value="{{formData.fees.electricity}}" bindinput="onInput"/></view>
            <view class="fee-item"><text class="fee-label">🔥 燃气</text><input class="fee-input" placeholder="如 3元/方" data-field="fees.gas" value="{{formData.fees.gas}}" bindinput="onInput"/></view>
            <view class="fee-item"><text class="fee-label">🏢 物业</text><input class="fee-input" placeholder="包含/自理" data-field="fees.propertyMgmt" value="{{formData.fees.propertyMgmt}}" bindinput="onInput"/></view>
            <view class="fee-item"><text class="fee-label">🌐 网费</text><input class="fee-input" placeholder="包含/自理" data-field="fees.internet" value="{{formData.fees.internet}}" bindinput="onInput"/></view>
            <view class="fee-item"><text class="fee-label">🚗 停车</text><input class="fee-input" placeholder="包含/自理" data-field="fees.parking" value="{{formData.fees.parking}}" bindinput="onInput"/></view>
            <view class="fee-item"><text class="fee-label">🤵 服务</text><input class="fee-input" placeholder="包含/自理" data-field="fees.serviceFee" value="{{formData.fees.serviceFee}}" bindinput="onInput"/></view>
        </view>
     </view>

    <!-- 3. Description & Facilities -->
    <view class="form-section glass-card">
        <view class="section-title">3. 详细配置</view>

        <view class="form-group-title">公寓亮点</view>
        <view class="tag-selector">
            <block wx:for="{{tagOptions}}" wx:key="*this">
                <view class="tag-option {{utils.includes(formData.tags, item) ? 'active' : ''}}" bindtap="toggleTag" data-tag="{{item}}">{{item}}</view>
            </block>
        </view>

        <view class="form-group-title" style="margin-top: 24rpx;">周边配套</view>
        <view class="tag-selector">
            <block wx:for="{{nearbyOptions}}" wx:key="*this">
                <view class="tag-option {{utils.includes(formData.nearbyFacilities, item) ? 'active' : ''}}" bindtap="toggleNearby" data-item="{{item}}">{{item}}</view>
            </block>
        </view>
        
        <view class="form-item" style="margin-top: 24rpx;">
            <text class="label">公寓描述</text>
            <textarea class="desc-textarea" placeholder="详细介绍公寓状况、交通、周边设施..." data-field="desc" value="{{formData.desc}}" bindinput="onInput" maxlength="1000"></textarea>
         </view>
    </view>
    
    <!-- 4. Room Management (The Core Feature) -->
    <view class="form-section glass-card" style="border: 2rpx solid #d8b4fe;">
        <view class="section-title" style="border-left-color: #9333ea;">4. 房间管理</view>
        
        <block wx:if="{{formData.units.length > 0}}">
            <view class="units-grid">
                <block wx:for="{{formData.units}}" wx:key="index">
                    <view class="unit-card" bindtap="onEditUnit" data-index="{{index}}">
                        <image src="{{item.images[0] || ''}}" class="unit-thumb" mode="aspectFill"></image>
                        <view class="unit-info">
                            <view class="unit-title">{{item.roomNo}}</view>
                            <view class="unit-desc">{{item.layout}} · {{item.area}}㎡</view>
                            <view class="unit-price">¥{{item.rent}}/月</view>
                        </view>
                         <view class="delete-unit-btn" catchtap="onDeleteUnit" data-index="{{index}}">🗑</view>
                    </view>
                </block>
            </view>
        </block>
        <block wx:else>
            <view class="empty-units">
                <text>🏢 暂无房间数据</text>
                <text style="font-size: 24rpx; color: #94a3b8;">请点击下方按钮添加</text>
            </view>
        </block>
        
        <button class="add-unit-btn" bindtap="onAddUnit">+ 添加房间</button>
    </view>

    <!-- 5. Media -->
    <view class="form-section glass-card">
      <view class="section-title">5. 公寓外观/大堂</view>
      
      <view class="image-grid">
        <block wx:for="{{formData.images}}" wx:key="*this">
            <view class="image-item">
                <image src="{{item}}" mode="aspectFill" class="thumb"></image>
                <view class="delete-btn" catchtap="removeImage" data-index="{{index}}">×</view>
            </view>
        </block>
        <view class="image-item add-btn" bindtap="chooseImage" wx:if="{{formData.images.length < 9}}">
            <text class="plus">+</text>
        </view>
      </view>
    </view>

    <!-- 6. Contacts -->
     <view class="form-section glass-card">
        <view class="section-title">6. 联系人信息</view>
         <block wx:for="{{formData.landlordContacts}}" wx:key="index">
            <view class="contact-row">
                <input class="input contact-input" placeholder="姓名" data-index="{{index}}" data-field="name" value="{{item.name}}" bindinput="updateContact" />
                <input class="input contact-input" placeholder="电话" data-index="{{index}}" data-field="phone" value="{{item.phone}}" bindinput="updateContact" />
                 <view wx:if="{{index > 0}}" class="remove-contact" catchtap="removeContact" data-index="{{index}}">×</view>
            </view>
         </block>
         <view class="add-contact-link" bindtap="addContact">+ 添加联系人</view>
    </view>

    <view style="height: 180rpx;"></view>
  </scroll-view>

  <view class="bottom-bar glass-card">
    <button class="submit-btn" bindtap="onSubmit">确认录入</button>
  </view>
</view>

<wxs module="utils">
module.exports.includes = function(arr, item) {
  return arr && arr.indexOf(item) > -1
}
</wxs>
