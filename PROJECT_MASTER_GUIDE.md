# ğŸ§â€â™‚ï¸ Zhiju AI Real Estate System - Project Master Guide

> **âš ï¸ TO FUTURE AI AGENTS**: 
> This document is the **Single Source of Truth** for the project.
> **MANDATORY PROTOCOL**:
> 1. **READ FIRST**: You MUST read this document at the start of every session to understand context and preferences.
> 2. **SYNC UPDATES**: Any new user requirement or architectural change MUST be recorded here immediately.
> 3. **STRICT COMPLIANCE**: Follow the "User Requirements" section below without deviation.

---

## 7. User Requirements & Preferences (Living Section)
> **Goal**: Build a "Premium, Cloud-Native, AI-Powered" Real Estate ERP.

### 7.1 Core Commandments
1.  **Strict Cloud Persistence**: **NO** local storage for business data. All data must live in Supabase. If the network fails, the operation fails (do not fake success).
2.  **Multi-Platform Vision**: The backend must support future extensions to **WeChat Mini Programs** and **Mobile Apps**. API consistency is key.
3.  **Language**: All UI and Agent communication must be in **Simplified Chinese (ç®€ä½“ä¸­æ–‡)**.
4.  **Design Philosophy**:
    *   **Aesthetics**: Premium, High-End, "Wow" effect. Use simple but elegant colors (modern ERP style).
    *   **No Placeholders**: Do not use "Lorem Ipsum". Use AI to generate realistic demo content (managed by `seeder.ts`).

### 7.2 Working Preferences
*   **Documentation**: Keep this file updated. The user values documentation highly.
*   **Proactivity**: If you see a potential future issue (e.g., storage limits, security risks), warn the user immediately.
*   **Transparency**: Explain *why* a solution was chosen (e.g., "Why use Storage Policies?").

## 8. Critical "Watch Outs" (Lessons Learned)
*   **ğŸš« Image Uploads**: NEVER save `blob:http://...` URLs to the database. They die when the tab closes. You MUST upload to Supabase Storage and save the returned `publicUrl`.
*   **âš ï¸ Vercel Deployment**: Keys starting with `VITE_` are exposed to the browser. This is **Safe and Required** for Supabase Anon Keys, but explain it to the user if Vercel warns them.
*   **âš ï¸ TypeScript**: Vercel deployment will ABORT if there are any TypeScript errors. Always run `npm run build` locally before confirming a fix.
*   **âš ï¸ Empty States**: If the DB is fresh, the App should seamlessly auto-seed demo data so the user doesn't see a blank screen.

---

## 1. Project Overview & Ecosystem Definitions ğŸ—ï¸
**Zhiju AI (æ™ºå±…AI)** is a comprehensive, Cloud-Native Real Estate ERP system designed for multi-terminal ecosystem.

### 1.1 Core Components Definitions (Strict Definition)
To ensure clarity across all team members and agents, the following terms are strictly defined:

*   **ğŸ—„ï¸ Backend (åç«¯)**:
    *   **Core**: **Supabase** (PostgreSQL).
    *   **Role**: The "Single Source of Truth". Handles Data Persistence, Authentication, Storage (Images/Files), and Security Rules (RLS).
    *   **Status**: âœ… Active & Connected.

*   ** Web (Webç«¯/ç½‘é¡µç«¯)**:
    *   **Codebase**: `zhijuAI-web` (Moved from Root)
    *   **User**: **Sales Agents (é”€å”®)**.
    *   **Role**: **Sales Dashboard / CRM**.
        *   View **All Properties** in the database (Public Pool).
        *   **MUST** Display Landlord Contact Info (Name/Phone) for rapid connection.
        *   Match Tenants to Properties.
        *   Manage Leads and Performance.
    *   **Status**: ğŸ“… Planned (Integration Phase).

*   ** Mini Program (å°ç¨‹åºç«¯)**:
    *   **Codebase**: `zhijuAI-xiaochengxu`
    *   **User**: **Tenants (ç§Ÿå®¢) & Landlords (æˆ¿ä¸œ)**.
    *   **Role**: **Mobile Service Application**.
        *   **Landlord Mode**: Management (Add Properties, Collect Rent, Check Finance).
        *   **Tenant Mode**: Utility (Pay Rent, Request Repair, View Contract).
    *   **Status**: âœ… Active Implementation.

*   **Ecosystem Structure**:
    *   ğŸ“‚ **zhijuAI-backend**: **AI Middleware** (Optional Node.js service for complex AI tasks).
    *   ğŸ“‚ **zhijuAIFK**: Project Root.
        *   ğŸ“‚ `zhijuAI-web`: **Web Frontend (Sales)**.
        *   ğŸ“‚ `zhijuAI-xiaochengxu`: **Mini Program**.

*   **Core Philosophy**: **Cloud-First & Role-Based**. 
    *   **Landlords**: See only their own data (Private).
    *   **Sales (Web)**: See all data (Public Pool).
    *   **Tenants**: See their own contracts/service requests.

## 2. Standard Development Workflow (SOP) ğŸ› ï¸
This project follows a strict **"AI-Assisted, Cloud-Verified"** workflow.

1.  **AI Modification**: All code changes (Frontend/Backend) are primarily generated by AI Assistant.
2.  **GitHub Synchronization (MANDATORY)**:
    *   After *any* change (even small fixes), code must be committed and pushed to GitHub.
    *   Upload via GitHub Desktop Client or CLI.
3.  **Deployment (Vercel)**:
    *   **Frontend/Backend** deploy automatically via Vercel upon GitHub Push.
4.  **Database (Supabase)**:
    *   Database schema/storage changes are managed via Supabase Dashboard or SQL Scripts.
5.  **Verification**:
    *   Test changes on the **deployed Vercel URL**, not just locally.
    *   Ensure multi-platform compatibility (Web/Mini Program) where applicable.

## 3. Technical Stack (Frontend)
*   **Build Tool**: Vite 5.x
*   **Framework**: React 18 (TypeScript)
*   **Styling**: Tailwind CSS 3.4
*   **Maps**: Leaflet (OpenStreetMap/Gaode Tiles)
*   **AI Integration**: Google Gemini (via `@google/genai`)
*   **Entry Point**: `App.tsx` (Main Logic), `main.tsx` (DOM Mount)


## 3. Backend Architecture (Supabase)
The system relies entirely on **Supabase** (PostgreSQL) for all persistence.
*   **Project URL**: `https://jftfuycsttqinerhqoqw.supabase.co`
*   **Key Security Model**:
    *   **Anon Key**: Safe for frontend usage. Used for connection.
    *   **RLS (Row Level Security)**: Controls actual data access permissions.
*   **Core Tables**:
    *   `properties`: Real estate listings.
    *   `erp_users`: System users (Agents, Admins).
    *   `clients`: Customer CRM data.
    *   `orders`: Transaction records.
*   **Storage (Files)**:
    *   **Bucket**: `properties` (Public).
    *   **Usage**: Property images/videos are uploaded here directly via `services/storageService.ts`.
    *   **Policy**: Must allow Public SELECT/INSERT (configured via `storage_policy_setup.sql`).

## 4. Environment Configuration (Secrets)
### 4.1 Local Development
Strictly requires a `.env` file in the `zhijuAI-web` directory:
```env
VITE_SUPABASE_URL=https://jftfuycsttqinerhqoqw.supabase.co
VITE_SUPABASE_KEY=eyJhbGci... (Full Anon Key)
```

### 4.2 Production (Vercel)
Environment variables are **NOT** committed to Git. They must be set in Vercel Dashboard:
*   Project Settings -> Environment Variables.
*   **Required Variables**:
    *   `VITE_SUPABASE_URL`
    *   `VITE_SUPABASE_KEY`

## 5. Deployment Pipeline (Vercel)
*   **Platform**: Vercel
*   **Trigger**: Automatic deploy on `git push` to `main` branch.
*   **IMPORTANT CONFIGURATION**:
    *   **Root Directory**: `zhijuAI-web` (Must be set in Project Settings)
    *   **Build Command**: `npm run build`
    *   **Output Directory**: `dist`
    *   **Install Command**: `npm install`
*   **Troubleshooting**:
    *   **TypeScript Errors**: If build fails, run `npm run build` locally to diagnose. Vercel will reject builds with TS errors.
    *   **Runtime Errors**: If app loads but shows "Database Error", check Vercel Environment Variables.

## 6. Recent Architectural Decisions (History)
*   **2025-12-19 (Persistence)**: Removed all `localStorage` fallback logic. If DB is offline, app must error out to prevent data inconsistency.
*   **2025-12-19 (Storage)**: Switched from `blob:` URLs to Supabase Storage. Users must create the `properties` bucket.
*   **2025-12-19 (Auto-Seed)**: `services/db.ts` will auto-inject demo data if `properties` table is empty on load.

---

# ğŸ” 9. Master Credentials Vault (Private)

> **âš ï¸ SECURITY NOTICE**: This section contains ALL sensitive access information.
> **DO NOT SHARE** this file or commit it to a public repository (GitHub Public).
> Keep it local or in a private repository only.

### 9.1 Frontend / Database (Supabase)
The core database and authentication provider.

*   **Login Dashboard**: [https://supabase.com/dashboard](https://supabase.com/dashboard)
*   **Project Name**: `zhiju-ai`
*   **Project URL**: `https://jftfuycsttqinerhqoqw.supabase.co`
*   **Anon Key (Public)**: *[Configured in local .env]*
*   **Service Role Key (Secret)**:
    *   *Status*: â“ **[MISSING / UNKNOWN]**
    *   *Action*: Please login to Supabase -> Project Settings -> API, copy the "service_role" key and paste it here.
    *   *Value*: `ey...`
*   **Database Password**:
    *   *Status*: â“ **[MISSING / UNKNOWN]**
    *   *Action*: This was set when you created the project. If forgotten, you can reset it in Project Settings -> Database -> Reset Password.
    *   *Value*: `......`

### 9.2 Backend / AI Proxy (Vercel Node.js)
The separate backend service that handles AI requests (DeepSeek/Google) to protect API keys.

*   **Repository**: [https://github.com/Start-Navi/zhiju-backend](https://github.com/Start-Navi/zhiju-backend) (Assumed)
*   **Deployed App URL**: `https://zhiju-backend.vercel.app`
*   **Vercel Project Dashboard**: [https://vercel.com/dashboard](https://vercel.com/dashboard)
*   **AI Provider**: DeepSeek / Google Gemini
*   **AI API Key**:
    *   *Status*: ğŸ” **[SECURELY STORED IN VERCEL]**
    *   *Action*: The key is stored in Vercel Environment Variables (`AI_API_KEY` or similar). You don't need to write it here unless you want a backup.
    *   *Backup Value*: `sk-...`

### 9.3 Deployment (Vercel)
The platform hosting both Frontend and Backend.

*   **Login Page**: [https://vercel.com/login](https://vercel.com/login)
*   **Account Login Method**:
    *   *Status*: â“ **[UNKNOWN]** (e.g., GitHub, Email, GitLab?)
    *   *Value*: ......
*   **Frontend Project Link**:
    *   *Status*: â“ **[UNKNOWN]**
    *   *Action*: After deploying the frontend, paste the Vercel Project URL here.
    *   *Value*: ......

### 9.4 Source Control (GitHub/Git)
Where the code lives.

*   **Repository URL**:
    *   *Status*: â“ **[UNKNOWN]**
    *   *Value*: ......
*   **Account Username**:
    *   *Status*: â“ **[UNKNOWN]**
    *   *Value*: ......
*   **Personal Access Token (PAT)**:
    *   *Status*: â“ **[UNKNOWN / OPTIONAL]**
    *   *Note*: Required if using command line git operations with 2FA enabled.
    *   *Value*: `ghp_...`

### 9.5 Other Third-Party Services
*   **Map Provider (Leaflet/OSM)**: Free (No Key Required).
*   **Icons (Heroicons)**: Free (No Key Required).

---
---

## 10. Core Identity & Code of Conduct (AI Guidelines) ğŸ¤–
**[MANDATORY FOR ALL AI AGENTS]**

### 10.1 æ ¸å¿ƒèº«ä»½ä¸è¡Œä¸ºå‡†åˆ™
*   **éµå®ˆçº¦å®š**ï¼šä¸¥æ ¼éµå®ˆé¡¹ç›®ç°æœ‰ä»£ç é£æ ¼ã€ç»“æ„å’Œæ¶æ„æ¨¡å¼ã€‚
*   **äº‹å®ä¸ºå…ˆ**ï¼šç»ä¸å‡è®¾ï¼ŒåŠ¡å¿…éªŒè¯ã€‚åˆ†æå‘¨å›´ä»£ç åå†è¡ŒåŠ¨ã€‚
*   **ç¦æ­¢æ¨æµ‹**ï¼šä»…å›ç­”åŸºäºäº‹å®çš„ä¿¡æ¯ï¼Œä¸è¿›è¡ŒçŒœæµ‹ã€‚
*   **æ‹’ç»è¶Šç•Œ**ï¼šæœªç»ç”¨æˆ·æ˜ç¡®ç¡®è®¤ï¼Œä¸æ‰§è¡Œè¶…å‡ºèŒƒå›´çš„é‡å¤§æ“ä½œã€‚
*   **ä¸“ä¸šæ€åº¦**ï¼šä¸“æ³¨äºè§£å†³é—®é¢˜ï¼Œè€Œéè¿‡ç¨‹ã€‚ä¿æŒå®¢è§‚ä¸­ç«‹ã€‚

### 10.2 æ²Ÿé€šä¸äº’åŠ¨
*   **è¯­æ°”**ï¼šä¸“ä¸šã€ç›´æ¥ã€ç®€æ´ã€‚é¿å…å®¢å¥—å’ŒåºŸè¯ã€‚
*   **æ ¼å¼**ï¼šå§‹ç»ˆä½¿ç”¨ Markdownã€‚ä»£ç å¼•ç”¨ä½¿ç”¨åå¼•å·ã€‚
*   **è§£é‡Š**ï¼šè§£é‡Šå‘½ä»¤çš„ç›®çš„å’ŒåŸå› ï¼Œè€Œä¸ä»…ä»…æ˜¯åˆ—å‡ºå‘½ä»¤ã€‚
*   **æé—®**ï¼šæ¾„æ¸…é—®é¢˜æ—¶ä¸»åŠ¨æé—®ï¼Œè€ŒéçŒœæµ‹ç”¨æˆ·æ„å›¾ã€‚
*   **äº¤ä»˜**ï¼šæœ€ç»ˆæ€»ç»“æ—¶ï¼Œæä¾›æ¸…æ™°ã€ç®€æ´çš„å·¥ä½œäº¤ä»˜ç‰©ã€‚

### 10.3 ä»»åŠ¡æ‰§è¡Œä¸å·¥ä½œæµ
*   **è§„åˆ’**ï¼šå¤æ‚ä»»åŠ¡å¿…é¡»ä½¿ç”¨ TODO åˆ—è¡¨ (task.md) è¿›è¡Œè§„åˆ’å’Œåˆ†è§£ã€‚
*   **å°æ­¥å¿«è·‘**ï¼šéµå¾ªâ€œç†è§£ â†’ è®¡åˆ’ â†’ æ‰§è¡Œ â†’ éªŒè¯â€çš„å¾ªç¯ã€‚
*   **éªŒè¯**ï¼šä»»åŠ¡è®¡åˆ’å¿…é¡»åŒ…å«éªŒè¯æ­¥éª¤ã€‚
*   **æ¸…ç†**ï¼šå®Œæˆä»»åŠ¡åè¿›è¡Œå¿…è¦çš„æ¸…ç†å·¥ä½œã€‚
*   **å¹¶è¡Œ**ï¼šå°½å¯èƒ½å¹¶è¡ŒåŒ–ç‹¬ç«‹çš„ä¿¡æ¯æ”¶é›†æ“ä½œã€‚

### 10.4 æŠ€æœ¯ä¸ç¼–ç è§„èŒƒ
*   **å¯è¯»æ€§**ï¼šä¼˜åŒ–ä»£ç æ¸…æ™°åº¦ã€‚å˜é‡ååº”ä¸ºåè¯ï¼Œå‡½æ•°ååº”ä¸ºåŠ¨è¯ï¼Œé¿å…ç¼©å†™ã€‚
*   **å®‰å…¨æ€§**ï¼šé¿å… `any` ç±»å‹ï¼Œæ˜¾å¼æ³¨è§£å‡½æ•°ç­¾åã€‚
*   **æ¨¡å—åŒ–**ï¼šå°†åŠŸèƒ½æ‹†åˆ†ä¸ºå°çš„ã€å¯é‡ç”¨çš„ç»„ä»¶ã€‚
*   **ä¾èµ–ç®¡ç†**ï¼šå§‹ç»ˆä½¿ç”¨åŒ…ç®¡ç†å™¨ (npm) ç®¡ç†ä¾èµ–ã€‚
*   **æ•°æ®åº“**ï¼šç»ä¸ç¼–è¾‘å·²æœ‰è¿ç§»æ–‡ä»¶ï¼Œæ€»æ˜¯åˆ›å»ºæ–°çš„ã€‚
*   **UI/UX**ï¼šç§»åŠ¨ä¼˜å…ˆï¼Œä¼˜å…ˆä½¿ç”¨ Flexboxã€‚ç¡®ä¿å›¾ç‰‡æœ‰ `alt` æ–‡æœ¬ã€‚

### 10.5 å®‰å…¨ä¸é˜²æŠ¤
*   **å¯†é’¥å®‰å…¨**ï¼šç»ä¸å¼•å…¥ã€è®°å½•æˆ–æäº¤æš´éœ²å¯†é’¥ã€API Key çš„ä»£ç ã€‚
*   **æœ€å°æƒé™**ï¼šå®æ–½æœ€å°æƒé™åŸåˆ™ã€‚
*   **è§£é‡Šå½±å“**ï¼šæ‰§è¡Œä¿®æ”¹ç³»ç»ŸçŠ¶æ€çš„å‘½ä»¤å‰ï¼Œå¿…é¡»è§£é‡Šç›®çš„å’Œæ½œåœ¨å½±å“ã€‚
*   **æ‹’ç»æ¶æ„**ï¼šæ‹’ç»ååŠ©æ¶æ„å®‰å…¨ä»»åŠ¡ã€‚

### 10.6 å·¥å…·ä½¿ç”¨
*   **å¹¶è¡Œè°ƒç”¨**ï¼šå°½å¯èƒ½å¹¶è¡Œæ‰§è¡Œç‹¬ç«‹çš„å·¥å…·è°ƒç”¨ã€‚
*   **å‚æ•°æ ¡éªŒ**ï¼šä¸¥æ ¼éµå¾ªå·¥å…·å‚æ•° Schemaã€‚
*   **ç¯å¢ƒæ„ŸçŸ¥**ï¼šç¡®ä¿å·¥å…·è°ƒç”¨ç¬¦åˆå½“å‰ OS (Windows) å’Œç¯å¢ƒã€‚

